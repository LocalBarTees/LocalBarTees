<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Generator with Logo</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 90%;
      font-size: 16px;
    }
    .qr-container {
      display: inline-block;
      border-radius: 18px;
      padding: 0;
      background: #fff;
      margin-top: 20px;
    }
    #qrcode {
      display: block;
      margin: 0 auto;
      background: #fff;
    }
    .powered-by {
      display: none; /* Not needed, text is drawn on canvas */
    }
    .url-preview {
      margin-top: 10px;
      font-size: 0.9em;
      color: #555;
      word-break: break-word;
    }
    #downloadBtn {
      display: none;
    }
    form {
      margin-top: 24px;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      font-size: 14px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div style="text-align:center;">
    <button type="button" id="backBtn" style="margin-bottom:24px; float:none; display:inline-block;">‚¨ÖÔ∏è Back</button>
  </div>
  <h1>QR Code Generator üç∏</h1>
  <p>Only works locally at the moment, meaning contact KK for a QR code.</p>
  <p>Enter a handle to generate a QR linking to:</p>
  <code>https://localbartees.com/{handle}?qr=yes</code>

  <form id="qrForm">
    <input type="text" id="handle" placeholder="Enter handle (e.g., gale)" required />
    <input type="text" id="clientName" placeholder="Client/Bar Name (e.g., Cocktail Gale's)" required />
    <input type="text" id="filename" placeholder="Filename (e.g., qr_gale.png)" />
    <button type="submit">Generate QR Code & XML</button>
  </form>
  <div class="url-preview" id="urlPreview"></div>
  <div class="qr-container">
    <canvas id="qrcode" width="1200" height="600"></canvas>
  </div>
  <!-- Poster canvas for download (hidden) -->
  <canvas id="poster" width="900" height="1200" style="display:none;"></canvas>
  <div class="powered-by">Powered by LocalBarTees.com</div>
  <br>
  <button id="downloadBtn" onclick="downloadQR()">Download QR Code</button>
  <div style="margin-top:8px; color:#888; font-size:13px;">
    Save to <b>qr/</b> folder in your project.
  </div>
  <div style="margin-top:24px;">
    <label for="xmlOutput"><b>Copy this &lt;code&gt; entry to qr/assets/qr.xml:</b></label>
    <textarea id="xmlOutput"></textarea>
    <button type="button" id="copyXmlBtn" style="margin-top:8px;">Copy Code</button>
    <span id="copyStatus" style="margin-left:10px;color:#00b894;font-size:13px;display:none;">Copied!</span>
  </div>

  <script>
    const logo = new Image();
    logo.src = 'qr_center.png';

    document.getElementById('qrForm').onsubmit = function(e) {
      e.preventDefault();
      generateQRandXML();
    };

    document.getElementById('handle').addEventListener('input', function() {
      const handle = this.value.trim();
      const filenameInput = document.getElementById('filename');
      // Only update if the user hasn't manually changed the filename
      if (!filenameInput.dataset.userEdited || filenameInput.value === '' || filenameInput.value === filenameInput.dataset.lastAuto) {
        const autoFilename = handle ? `qr_${handle}.png`.toLowerCase() : '';
        filenameInput.value = autoFilename;
        filenameInput.dataset.lastAuto = autoFilename;
        filenameInput.dataset.userEdited = '';
      }
    });
    document.getElementById('filename').addEventListener('input', function() {
      // Mark as user-edited if the value doesn't match the last auto-generated value
      if (this.value !== this.dataset.lastAuto) {
        this.dataset.userEdited = 'true';
      } else {
        this.dataset.userEdited = '';
      }
      // Always force .png to lowercase
      if (this.value.endsWith('.PNG')) {
        this.value = this.value.slice(0, -4) + '.png';
      }
    });

    function escapeXml(str) {
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
    }

    function generateQRandXML() {
      const handle = document.getElementById('handle').value.trim();
      const clientName = document.getElementById('clientName').value.trim();
      let filename = document.getElementById('filename').value.trim();
      if (!handle || !clientName) return;
      if (!filename || filename === `qr_.png`) filename = `qr_${handle}.png`;
      filename = filename.replace(/\.PNG$/i, '.png');
      document.getElementById('filename').value = filename;
      const url = `https://localbartees.com/${handle}?qr`;
      document.getElementById('urlPreview').textContent = url;

      // 4:3 ratio canvas (portrait: 900x1200)
      const canvas = document.getElementById('qrcode');
      canvas.width = 900;
      canvas.height = 1200;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Border and padding
      const borderRadius = 48;
      const borderWidth = 12;
      const padding = 40;

      // Draw rounded border
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(padding + borderRadius, padding);
      ctx.lineTo(canvas.width - padding - borderRadius, padding);
      ctx.quadraticCurveTo(canvas.width - padding, padding, canvas.width - padding, padding + borderRadius);
      ctx.lineTo(canvas.width - padding, canvas.height - padding - borderRadius);
      ctx.quadraticCurveTo(canvas.width - padding, canvas.height - padding, canvas.width - padding - borderRadius, canvas.height - padding);
      ctx.lineTo(padding + borderRadius, canvas.height - padding);
      ctx.quadraticCurveTo(padding, canvas.height - padding, padding, canvas.height - padding - borderRadius);
      ctx.lineTo(padding, padding + borderRadius);
      ctx.quadraticCurveTo(padding, padding, padding + borderRadius, padding);
      ctx.closePath();
      ctx.lineWidth = borderWidth;
      ctx.strokeStyle = "#000";
      ctx.stroke();
      ctx.restore();

      // White background inside border
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(padding + borderRadius, padding);
      ctx.lineTo(canvas.width - padding - borderRadius, padding);
      ctx.quadraticCurveTo(canvas.width - padding, padding, canvas.width - padding, padding + borderRadius);
      ctx.lineTo(canvas.width - padding, canvas.height - padding - borderRadius);
      ctx.quadraticCurveTo(canvas.width - padding, canvas.height - padding, canvas.width - padding - borderRadius, canvas.height - padding);
      ctx.lineTo(padding + borderRadius, canvas.height - padding);
      ctx.quadraticCurveTo(padding, canvas.height - padding, padding, canvas.height - padding - borderRadius);
      ctx.lineTo(padding, padding + borderRadius);
      ctx.quadraticCurveTo(padding, padding, padding + borderRadius, padding);
      ctx.closePath();
      ctx.clip();
      ctx.fillStyle = "#fff";
      ctx.fillRect(padding, padding, canvas.width - 2 * padding, canvas.height - 2 * padding);
      ctx.restore();

      // "SCAN HERE FOR {name} merch" above QR
      ctx.font = "bold 48px Arial";
      ctx.fillStyle = "#000";
      ctx.textAlign = "center";
      ctx.fillText(`SCAN HERE FOR`, canvas.width / 2, padding + 60);
      ctx.font = "bold 42px Arial";
      ctx.fillText(`${clientName} merch`, canvas.width / 2, padding + 120);

      // Generate high-res QR code to temp canvas
      QRCode.toCanvas(document.createElement('canvas'), url, {
        width: 400,
        margin: 2,
        color: { dark: '#000000', light: '#ffffff' }
      }, function (error, tempCanvas) {
        if (error) { console.error(error); return; }
        // Center QR code horizontally, vertically in the middle section
        const qrX = (canvas.width - 400) / 2;
        const qrY = padding + 150;
        ctx.drawImage(tempCanvas, qrX, qrY, 400, 400);
        // Draw logo if loaded
        const size = 100;
        const x = (canvas.width - size) / 2;
        const y = qrY + (400 - size) / 2;
        if (logo.complete) {
          ctx.drawImage(logo, x, y, size, size);
        } else {
          logo.onload = () => ctx.drawImage(logo, x, y, size, size);
        }
        // "powered by localbartees.com" below QR, all lowercase, dark gray
        ctx.font = "bold 32px Arial";
        ctx.fillStyle = "#444";
        ctx.textAlign = "center";
        ctx.fillText("powered by localbartees.com", canvas.width / 2, canvas.height - padding - 30);
        document.getElementById('downloadBtn').style.display = 'inline-block';
      });

      // Generate XML snippet with escaped values
      const now = new Date().toISOString();
      const xml = `<code uniqueId="${escapeXml(handle)}">\n  <name>${escapeXml(clientName)}</name>\n  <url>${escapeXml(url)}</url>\n  <filename>${escapeXml(filename)}</filename>\n  <size>900x1200</size>\n  <errorCorrection>M</errorCorrection>\n  <generated>${escapeXml(now)}</generated>\n</code>`;
      document.getElementById('xmlOutput').value = xml;
    }

    function downloadQR() {
      const handle = document.getElementById('handle').value.trim();
      const canvas = document.getElementById('qrcode');
      const link = document.createElement('a');
      link.download = `qr_${handle}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    document.getElementById('copyXmlBtn').onclick = function() {
      const xml = document.getElementById('xmlOutput').value;
      if (xml) {
        navigator.clipboard.writeText(xml).then(function() {
          const status = document.getElementById('copyStatus');
          status.style.display = 'inline';
          setTimeout(() => { status.style.display = 'none'; }, 1200);
        });
      }
    };

    document.getElementById('backBtn').onclick = function() {
      window.history.back();
    };
  </script>
</body>
</html>
