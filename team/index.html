<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Loading - Local Bar Tees</title>
  <link rel="icon" type="image/x-icon" href="assets/tshirt.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      line-height: 1.4;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 24px;
    }
    .business-card {
      background: #ffffff;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      width: 100%;
      max-width: 700px;
      aspect-ratio: 3.5 / 2;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 6px rgba(0,0,0,0.04);
      overflow: hidden;
      transition: box-shadow 0.2s ease;
      margin: 0 auto;
    }
    .card-content {
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    }
    
    .card-identity h2 {
      font-size: 24px;
      font-weight: 700;
    }
    .card-identity p {
      font-size: 14px;
      color: #6c757d;
    }
    .card-contact {
      list-style: none;
      margin: 20px 0;
    }
    .card-contact li {
      margin-bottom: 8px;
      font-size: 16px;
    }
    .card-contact a {
      color: #1a1a1a;
      text-decoration: none;
    }
    .card-footer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .card-qr {
      width: 100px;
      height: 100px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-left: 0;
      margin-top: 12px;
    }

    .card-brand {
      display: none;
    }
    .card-qr {
      width: 64px;
      height: 64px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .card-qr img {
      width: 100%;
      height: 100%;
    }
    .card-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 10px 16px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn:hover {
      background: #e9ecef;
    }
    .btn.nfc-active {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }
    .btn.nfc-active:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <div class="business-card" onclick="fullscreenCard()">
      <div class="card-content">
        <div class="card-header">
          <div class="card-identity">
            <h2>Loading...</h2>
            <p>Loading...</p>
          </div>
        </div>
        <ul class="card-contact"></ul>
        <div class="card-footer">
          <div class="card-brand"></div>
          <div class="card-qr"></div>
        </div>
      </div>
    </div>
    <div class="card-actions">
      <button class="btn" onclick="printCard()">Print</button>
      <button class="btn" onclick="shareCard()">Share</button>
      <button class="btn" id="nfcBtn" onclick="tapToShare()">Tap to Share</button>
      <button class="btn" onclick="fullscreenCard()">Full Screen</button>
    </div>
  </div>
  <script>
let currentMember = null;
let nfcActive = false;

function getUrlParameter(name) {
    name = name.replace(/[[\]]/g, '\$&');
    const regex = new RegExp('[?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

async function loadTeamData() {
    const memberId = getUrlParameter('id') || 'main';
    const paths = ['team.xml', './team.xml', '../assets/team.xml', 'assets/team.xml', '../team.xml'];
    let xml = null;

    for (const path of paths) {
        try {
            const response = await fetch(path);
            if (!response.ok) continue;
            const text = await response.text();
            const parser = new DOMParser();
            xml = parser.parseFromString(text, 'text/xml');
            if (xml.querySelector('parsererror')) continue;
            break;
        } catch (e) {
            continue;
        }
    }

    if (!xml) return;
    const member = xml.querySelector(`member[id="${memberId}"]`);
    if (!member) return;

    currentMember = {
        id: memberId,
        name: member.querySelector('name')?.textContent || 'Unknown',
        title: member.querySelector('title')?.textContent || '',
        phone: member.querySelector('phone')?.textContent || '',
        email: member.querySelector('email')?.textContent || '',
        website: member.querySelector('website')?.textContent || '',
        qr_url: member.querySelector('qr_url')?.textContent || '',
        logo: member.querySelector('logo')?.textContent || '',
        company: member.querySelector('company')?.textContent || ''
    };

    updateCard();
}

function updateCard() {
    document.title = `${currentMember.name}`;
        document.querySelector('.card-identity h2').textContent = currentMember.name;
    document.querySelector('.card-identity p').textContent = currentMember.title;

    const contactList = document.querySelector('.card-contact');
    contactList.innerHTML = '';
    if (currentMember.phone) contactList.innerHTML += `<li>üì± <a href="tel:${currentMember.phone}">${currentMember.phone}</a></li>`;
    if (currentMember.email) contactList.innerHTML += `<li>‚úâÔ∏è <a href="mailto:${currentMember.email}">${currentMember.email}</a></li>`;
    if (currentMember.website) contactList.innerHTML += `<li>üåê <a href="${currentMember.website}" target="_blank">${currentMember.website}</a></li>`;

    document.querySelector('.card-qr').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(currentMember.qr_url)}" alt="QR Code">`;
}

function printCard() {
    alert('Use Avery Template 5371');
    const printWindow = window.open('', '', 'width=800,height=1000');
    if (!printWindow) return;

    const card = document.querySelector('.business-card').outerHTML;
    printWindow.document.write(`
      <html>
        <head>
          <title>Print Business Cards</title>
          <style>
            @page {
              margin: 0.5in;
            }
            body {
              display: grid;
              grid-template-columns: repeat(2, 3.5in);
              grid-template-rows: repeat(5, 2in);
              gap: 0;
              padding: 0;
              margin: 0;
            }
            .business-card {
              width: 3.5in;
              height: 2in;
              box-shadow: none;
              border: 1px solid #ccc;
              margin: 0;
              page-break-inside: avoid;
            }
          </style>
        </head>
        <body>
          ${card.repeat(10)}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

function shareCard() {
    if (navigator.share) {
        navigator.share({ title: currentMember.name, url: window.location.href });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied to clipboard'));
    }
}

function fullscreenCard() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 10px;
    `;

    const clone = document.querySelector('.business-card').cloneNode(true);
    clone.style.cssText = `
      width: 90vw;
      height: auto;
      max-width: 90vw;
      max-height: 90vh;
      transform: none;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      background: white;
    `;

    modal.appendChild(clone);
    document.body.appendChild(modal);

    modal.onclick = () => document.body.removeChild(modal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') document.body.removeChild(modal);
    }, { once: true });
}
async function tapToShare() {
    const btn = document.getElementById('nfcBtn');
    if (!('NDEFReader' in window)) return alert('NFC not supported');
    if (!currentMember) return alert('Member data not loaded');

    try {
        const ndef = new NDEFReader();
        await ndef.scan();
        btn.classList.add('nfc-active');
        btn.textContent = 'Touch NFC Device';
        ndef.addEventListener('reading', async () => {
            try {
                await ndef.write({
                    records: [
                        { recordType: "url", data: currentMember.qr_url },
                        { recordType: "text", data: `${currentMember.name}
${currentMember.title}
${currentMember.phone}
${currentMember.email}
${currentMember.website}` }
                    ]
                });
                btn.textContent = 'Shared!';
                setTimeout(() => btn.textContent = 'Touch NFC Device', 2000);
            } catch (err) {
                alert('Failed to share via NFC');
            }
        });
    } catch (err) {
        alert('NFC permission denied or error occurred');
        btn.classList.remove('nfc-active');
        btn.textContent = 'Tap to Share';
    }
}

document.addEventListener('DOMContentLoaded', loadTeamData);
</script>
</body>
</html>
